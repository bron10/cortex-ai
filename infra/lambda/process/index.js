"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_s3_1 = require("@aws-sdk/client-s3");
const client_eventbridge_1 = require("@aws-sdk/client-eventbridge");
const dynamodbClient = new client_dynamodb_1.DynamoDBClient({});
const dynamodb = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamodbClient);
const s3 = new client_s3_1.S3Client({});
const eventbridge = new client_eventbridge_1.EventBridgeClient({});
const DATA_TABLE_NAME = process.env.DATA_TABLE_NAME;
const DATA_BUCKET_NAME = process.env.DATA_BUCKET_NAME;
const EVENT_BUS_NAME = process.env.EVENT_BUS_NAME;
const ENABLE_AI_INSIGHTS = process.env.ENABLE_AI_INSIGHTS === 'true';
const handler = async (event, context) => {
    try {
        console.log('Process function triggered:', JSON.stringify(event, null, 2));
        const { tenantId, dataId, s3Key, timestamp, metadata } = event.detail;
        // Retrieve data from S3 for processing
        const s3Object = await s3.send(new client_s3_1.GetObjectCommand({
            Bucket: DATA_BUCKET_NAME,
            Key: s3Key,
        }));
        if (!s3Object.Body) {
            throw new Error('No data found in S3 object');
        }
        const data = JSON.parse(await s3Object.Body.transformToString());
        // Process the data based on type
        const processingResults = await processData(data);
        // Calculate data size
        const dataSize = Buffer.byteLength(JSON.stringify(data), 'utf8');
        // Create processed data record
        const processedData = {
            tenantId,
            dataId,
            s3Key,
            timestamp,
            status: 'PROCESSED',
            processedAt: new Date().toISOString(),
            processingResults: {
                recordCount: Array.isArray(data) ? data.length : 1,
                dataSize,
                validationStatus: 'VALID',
                extractedFields: Object.keys(data),
                qualityScore: calculateQualityScore(data),
                ...processingResults,
            },
            metadata: metadata || {},
            ttl: Math.floor(Date.now() / 1000) + (365 * 24 * 60 * 60), // 1 year TTL
        };
        // Update DynamoDB record
        await dynamodb.send(new lib_dynamodb_1.UpdateCommand({
            TableName: DATA_TABLE_NAME,
            Key: {
                tenantId,
                dataId,
            },
            UpdateExpression: 'SET #status = :status, processedAt = :processedAt, processingResults = :processingResults',
            ExpressionAttributeNames: {
                '#status': 'status',
            },
            ExpressionAttributeValues: {
                ':status': 'PROCESSED',
                ':processedAt': processedData.processedAt,
                ':processingResults': processedData.processingResults,
            },
        }));
        console.log(`Data processed successfully: ${dataId} for tenant: ${tenantId}`);
        // Emit event for AI insights if enabled
        if (ENABLE_AI_INSIGHTS) {
            await eventbridge.send(new client_eventbridge_1.PutEventsCommand({
                Entries: [
                    {
                        Source: 'cortex-ai.process',
                        DetailType: 'DataProcessed',
                        Detail: JSON.stringify({
                            tenantId,
                            dataId,
                            s3Key,
                            timestamp,
                            processedAt: processedData.processedAt,
                            processingResults: processedData.processingResults,
                            metadata,
                        }),
                        EventBusName: EVENT_BUS_NAME,
                    },
                ],
            }));
        }
    }
    catch (error) {
        console.error('Error in process function:', error);
        // Update status to PROCESSING_FAILED
        try {
            const { tenantId, dataId } = event.detail;
            await dynamodb.send(new lib_dynamodb_1.UpdateCommand({
                TableName: DATA_TABLE_NAME,
                Key: {
                    tenantId,
                    dataId,
                },
                UpdateExpression: 'SET #status = :status, processingError = :error, processedAt = :processedAt',
                ExpressionAttributeNames: {
                    '#status': 'status',
                },
                ExpressionAttributeValues: {
                    ':status': 'PROCESSING_FAILED',
                    ':error': error.message,
                    ':processedAt': new Date().toISOString(),
                },
            }));
        }
        catch (updateError) {
            console.error('Failed to update status to PROCESSING_FAILED:', updateError);
        }
        throw error;
    }
};
exports.handler = handler;
async function processData(data) {
    const results = {};
    // Generic processing for any data type
    results.recordCount = Array.isArray(data) ? data.length : 1;
    results.extractedFields = Array.isArray(data) && data.length > 0 ? Object.keys(data[0]) : Object.keys(data);
    // Try to detect common patterns
    if (Array.isArray(data) && data.length > 0) {
        const sample = data[0];
        // Check for common fields and calculate metrics
        if (sample.email) {
            results.hasEmail = data.some((item) => item.email);
        }
        if (sample.phone) {
            results.hasPhone = data.some((item) => item.phone);
        }
        if (sample.amount || sample.price) {
            const amountField = sample.amount ? 'amount' : 'price';
            results.totalAmount = data.reduce((sum, item) => sum + (item[amountField] || 0), 0);
        }
        if (sample.category) {
            results.categories = [...new Set(data.map((item) => item.category).filter(Boolean))];
        }
        if (sample.level) {
            results.errorCount = data.filter((item) => item.level === 'error').length;
        }
    }
    return results;
}
function calculateQualityScore(data) {
    let score = 100;
    if (Array.isArray(data)) {
        if (data.length === 0)
            score -= 20;
        if (data.length > 1000)
            score -= 10;
        // Check for missing required fields
        const sample = data[0];
        if (sample) {
            score -= calculateMissingFieldsPenalty(sample);
        }
    }
    else {
        score -= calculateMissingFieldsPenalty(data);
    }
    return Math.max(0, score);
}
function calculateMissingFieldsPenalty(item) {
    let penalty = 0;
    // Generic penalty calculation for any data type
    if (!item.id && !item.name && !item.title)
        penalty += 10;
    if (Object.keys(item).length === 0)
        penalty += 20;
    return penalty;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSw4REFBMEQ7QUFDMUQsd0RBQThFO0FBQzlFLGtEQUFnRTtBQUNoRSxvRUFBa0Y7QUFFbEYsTUFBTSxjQUFjLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzlDLE1BQU0sUUFBUSxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUM3RCxNQUFNLEVBQUUsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDNUIsTUFBTSxXQUFXLEdBQUcsSUFBSSxzQ0FBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUU5QyxNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWdCLENBQUM7QUFDckQsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFpQixDQUFDO0FBQ3ZELE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBZSxDQUFDO0FBQ25ELE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsS0FBSyxNQUFNLENBQUM7QUE0QjlELE1BQU0sT0FBTyxHQUFHLEtBQUssRUFDMUIsS0FBMEQsRUFDMUQsT0FBZ0IsRUFDRCxFQUFFO0lBQ2pCLElBQUk7UUFDRixPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTNFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztRQUV0RSx1Q0FBdUM7UUFDdkMsTUFBTSxRQUFRLEdBQUcsTUFBTSxFQUFFLENBQUMsSUFBSSxD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Q0FBQyxLQUFLO1FBQUUsT0FBTyxJQUFJLEVBQUUsQ0FBQztJQUN6RCxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUM7UUFBRSxPQUFPLElBQUksRUFBRSxDQUFDO0lBRWxELE9BQU8sT0FBTyxDQUFDO0FBQ2pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEJyaWRnZUV2ZW50LCBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBVcGRhdGVDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IFMzQ2xpZW50LCBHZXRPYmplY3RDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7IEV2ZW50QnJpZGdlQ2xpZW50LCBQdXRFdmVudHNDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWV2ZW50YnJpZGdlJztcblxuY29uc3QgZHluYW1vZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZHluYW1vZGIgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vZGJDbGllbnQpO1xuY29uc3QgczMgPSBuZXcgUzNDbGllbnQoe30pO1xuY29uc3QgZXZlbnRicmlkZ2UgPSBuZXcgRXZlbnRCcmlkZ2VDbGllbnQoe30pO1xuXG5jb25zdCBEQVRBX1RBQkxFX05BTUUgPSBwcm9jZXNzLmVudi5EQVRBX1RBQkxFX05BTUUhO1xuY29uc3QgREFUQV9CVUNLRVRfTkFNRSA9IHByb2Nlc3MuZW52LkRBVEFfQlVDS0VUX05BTUUhO1xuY29uc3QgRVZFTlRfQlVTX05BTUUgPSBwcm9jZXNzLmVudi5FVkVOVF9CVVNfTkFNRSE7XG5jb25zdCBFTkFCTEVfQUlfSU5TSUdIVFMgPSBwcm9jZXNzLmVudi5FTkFCTEVfQUlfSU5TSUdIVFMgPT09ICd0cnVlJztcblxuaW50ZXJmYWNlIERhdGFVcGxvYWRlZEV2ZW50IHtcbiAgdGVuYW50SWQ6IHN0cmluZztcbiAgZGF0YUlkOiBzdHJpbmc7XG4gIHMzS2V5OiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogc3RyaW5nO1xuICBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT47XG59XG5cbmludGVyZmFjZSBQcm9jZXNzZWREYXRhIHtcbiAgdGVuYW50SWQ6IHN0cmluZztcbiAgZGF0YUlkOiBzdHJpbmc7XG4gIHMzS2V5OiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogc3RyaW5nO1xuICBzdGF0dXM6IHN0cmluZztcbiAgcHJvY2Vzc2VkQXQ6IHN0cmluZztcbiAgcHJvY2Vzc2luZ1Jlc3VsdHM6IHtcbiAgICByZWNvcmRDb3VudD86IG51bWJlcjtcbiAgICBkYXRhU2l6ZT86IG51bWJlcjtcbiAgICB2YWxpZGF0aW9uU3RhdHVzOiBzdHJpbmc7XG4gICAgZXh0cmFjdGVkRmllbGRzPzogc3RyaW5nW107XG4gICAgcXVhbGl0eVNjb3JlPzogbnVtYmVyO1xuICB9O1xuICBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT47XG4gIHR0bDogbnVtYmVyO1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEV2ZW50QnJpZGdlRXZlbnQ8J0RhdGFVcGxvYWRlZCcsIERhdGFVcGxvYWRlZEV2ZW50PixcbiAgY29udGV4dDogQ29udGV4dFxuKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc29sZS5sb2coJ1Byb2Nlc3MgZnVuY3Rpb24gdHJpZ2dlcmVkOicsIEpTT04uc3RyaW5naWZ5KGV2ZW50LCBudWxsLCAyKSk7XG5cbiAgICBjb25zdCB7IHRlbmFudElkLCBkYXRhSWQsIHMzS2V5LCB0aW1lc3RhbXAsIG1ldGFkYXRhIH0gPSBldmVudC5kZXRhaWw7XG5cbiAgICAvLyBSZXRyaWV2ZSBkYXRhIGZyb20gUzMgZm9yIHByb2Nlc3NpbmdcbiAgICBjb25zdCBzM09iamVjdCA9IGF3YWl0IHMzLnNlbmQobmV3IEdldE9iamVjdENvbW1hbmQoe1xuICAgICAgQnVja2V0OiBEQVRBX0JVQ0tFVF9OQU1FLFxuICAgICAgS2V5OiBzM0tleSxcbiAgICB9KSk7XG5cbiAgICBpZiAoIXMzT2JqZWN0LkJvZHkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gZGF0YSBmb3VuZCBpbiBTMyBvYmplY3QnKTtcbiAgICB9XG5cbiAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShhd2FpdCBzM09iamVjdC5Cb2R5LnRyYW5zZm9ybVRvU3RyaW5nKCkpO1xuICAgIFxuICAgIC8vIFByb2Nlc3MgdGhlIGRhdGEgYmFzZWQgb24gdHlwZVxuICAgIGNvbnN0IHByb2Nlc3NpbmdSZXN1bHRzID0gYXdhaXQgcHJvY2Vzc0RhdGEoZGF0YSk7XG4gICAgXG4gICAgLy8gQ2FsY3VsYXRlIGRhdGEgc2l6ZVxuICAgIGNvbnN0IGRhdGFTaXplID0gQnVmZmVyLmJ5dGVMZW5ndGgoSlNPTi5zdHJpbmdpZnkoZGF0YSksICd1dGY4Jyk7XG4gICAgXG4gICAgLy8gQ3JlYXRlIHByb2Nlc3NlZCBkYXRhIHJlY29yZFxuICAgIGNvbnN0IHByb2Nlc3NlZERhdGE6IFByb2Nlc3NlZERhdGEgPSB7XG4gICAgICB0ZW5hbnRJZCxcbiAgICAgIGRhdGFJZCxcbiAgICAgIHMzS2V5LFxuICAgICAgdGltZXN0YW1wLFxuICAgICAgc3RhdHVzOiAnUFJPQ0VTU0VEJyxcbiAgICAgIHByb2Nlc3NlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICBwcm9jZXNzaW5nUmVzdWx0czoge1xuICAgICAgICByZWNvcmRDb3VudDogQXJyYXkuaXNBcnJheShkYXRhKSA/IGRhdGEubGVuZ3RoIDogMSxcbiAgICAgICAgZGF0YVNpemUsXG4gICAgICAgIHZhbGlkYXRpb25TdGF0dXM6ICdWQUxJRCcsXG4gICAgICAgIGV4dHJhY3RlZEZpZWxkczogT2JqZWN0LmtleXMoZGF0YSksXG4gICAgICAgIHF1YWxpdHlTY29yZTogY2FsY3VsYXRlUXVhbGl0eVNjb3JlKGRhdGEpLFxuICAgICAgICAuLi5wcm9jZXNzaW5nUmVzdWx0cyxcbiAgICAgIH0sXG4gICAgICBtZXRhZGF0YTogbWV0YWRhdGEgfHwge30sXG4gICAgICB0dGw6IE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDEwMDApICsgKDM2NSAqIDI0ICogNjAgKiA2MCksIC8vIDEgeWVhciBUVExcbiAgICB9O1xuXG4gICAgLy8gVXBkYXRlIER5bmFtb0RCIHJlY29yZFxuICAgIGF3YWl0IGR5bmFtb2RiLnNlbmQobmV3IFVwZGF0ZUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBEQVRBX1RBQkxFX05BTUUsXG4gICAgICBLZXk6IHtcbiAgICAgICAgdGVuYW50SWQsXG4gICAgICAgIGRhdGFJZCxcbiAgICAgIH0sXG4gICAgICBVcGRhdGVFeHByZXNzaW9uOiAnU0VUICNzdGF0dXMgPSA6c3RhdHVzLCBwcm9jZXNzZWRBdCA9IDpwcm9jZXNzZWRBdCwgcHJvY2Vzc2luZ1Jlc3VsdHMgPSA6cHJvY2Vzc2luZ1Jlc3VsdHMnLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICcjc3RhdHVzJzogJ3N0YXR1cycsXG4gICAgICB9LFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOnN0YXR1cyc6ICdQUk9DRVNTRUQnLFxuICAgICAgICAnOnByb2Nlc3NlZEF0JzogcHJvY2Vzc2VkRGF0YS5wcm9jZXNzZWRBdCxcbiAgICAgICAgJzpwcm9jZXNzaW5nUmVzdWx0cyc6IHByb2Nlc3NlZERhdGEucHJvY2Vzc2luZ1Jlc3VsdHMsXG4gICAgICB9LFxuICAgIH0pKTtcblxuICAgIGNvbnNvbGUubG9nKGBEYXRhIHByb2Nlc3NlZCBzdWNjZXNzZnVsbHk6ICR7ZGF0YUlkfSBmb3IgdGVuYW50OiAke3RlbmFudElkfWApO1xuXG4gICAgLy8gRW1pdCBldmVudCBmb3IgQUkgaW5zaWdodHMgaWYgZW5hYmxlZFxuICAgIGlmIChFTkFCTEVfQUlfSU5TSUdIVFMpIHtcbiAgICAgIGF3YWl0IGV2ZW50YnJpZGdlLnNlbmQobmV3IFB1dEV2ZW50c0NvbW1hbmQoe1xuICAgICAgICBFbnRyaWVzOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgU291cmNlOiAnY29ydGV4LWFpLnByb2Nlc3MnLFxuICAgICAgICAgICAgRGV0YWlsVHlwZTogJ0RhdGFQcm9jZXNzZWQnLFxuICAgICAgICAgICAgRGV0YWlsOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgIHRlbmFudElkLFxuICAgICAgICAgICAgICBkYXRhSWQsXG4gICAgICAgICAgICAgIHMzS2V5LFxuICAgICAgICAgICAgICB0aW1lc3RhbXAsXG4gICAgICAgICAgICAgIHByb2Nlc3NlZEF0OiBwcm9jZXNzZWREYXRhLnByb2Nlc3NlZEF0LFxuICAgICAgICAgICAgICBwcm9jZXNzaW5nUmVzdWx0czogcHJvY2Vzc2VkRGF0YS5wcm9jZXNzaW5nUmVzdWx0cyxcbiAgICAgICAgICAgICAgbWV0YWRhdGEsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIEV2ZW50QnVzTmFtZTogRVZFTlRfQlVTX05BTUUsXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgIH0pKTtcbiAgICB9XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBwcm9jZXNzIGZ1bmN0aW9uOicsIGVycm9yKTtcbiAgICBcbiAgICAvLyBVcGRhdGUgc3RhdHVzIHRvIFBST0NFU1NJTkdfRkFJTEVEXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgdGVuYW50SWQsIGRhdGFJZCB9ID0gZXZlbnQuZGV0YWlsO1xuICAgICAgYXdhaXQgZHluYW1vZGIuc2VuZChuZXcgVXBkYXRlQ29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogREFUQV9UQUJMRV9OQU1FLFxuICAgICAgICBLZXk6IHtcbiAgICAgICAgICB0ZW5hbnRJZCxcbiAgICAgICAgICBkYXRhSWQsXG4gICAgICAgIH0sXG4gICAgICAgIFVwZGF0ZUV4cHJlc3Npb246ICdTRVQgI3N0YXR1cyA9IDpzdGF0dXMsIHByb2Nlc3NpbmdFcnJvciA9IDplcnJvciwgcHJvY2Vzc2VkQXQgPSA6cHJvY2Vzc2VkQXQnLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgICAnI3N0YXR1cyc6ICdzdGF0dXMnLFxuICAgICAgICB9LFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgJzpzdGF0dXMnOiAnUFJPQ0VTU0lOR19GQUlMRUQnLFxuICAgICAgICAgICc6ZXJyb3InOiAoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2UsXG4gICAgICAgICAgJzpwcm9jZXNzZWRBdCc6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgfSxcbiAgICAgIH0pKTtcbiAgICB9IGNhdGNoICh1cGRhdGVFcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHVwZGF0ZSBzdGF0dXMgdG8gUFJPQ0VTU0lOR19GQUlMRUQ6JywgdXBkYXRlRXJyb3IpO1xuICAgIH1cbiAgICBcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufTtcblxuYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0RhdGEoZGF0YTogYW55KTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBhbnk+PiB7XG4gIGNvbnN0IHJlc3VsdHM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcbiAgXG4gIC8vIEdlbmVyaWMgcHJvY2Vzc2luZyBmb3IgYW55IGRhdGEgdHlwZVxuICByZXN1bHRzLnJlY29yZENvdW50ID0gQXJyYXkuaXNBcnJheShkYXRhKSA/IGRhdGEubGVuZ3RoIDogMTtcbiAgcmVzdWx0cy5leHRyYWN0ZWRGaWVsZHMgPSBBcnJheS5pc0FycmF5KGRhdGEpICYmIGRhdGEubGVuZ3RoID4gMCA/IE9iamVjdC5rZXlzKGRhdGFbMF0pIDogT2JqZWN0LmtleXMoZGF0YSk7XG4gIFxuICAvLyBUcnkgdG8gZGV0ZWN0IGNvbW1vbiBwYXR0ZXJuc1xuICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSAmJiBkYXRhLmxlbmd0aCA+IDApIHtcbiAgICBjb25zdCBzYW1wbGUgPSBkYXRhWzBdO1xuICAgIFxuICAgIC8vIENoZWNrIGZvciBjb21tb24gZmllbGRzIGFuZCBjYWxjdWxhdGUgbWV0cmljc1xuICAgIGlmIChzYW1wbGUuZW1haWwpIHtcbiAgICAgIHJlc3VsdHMuaGFzRW1haWwgPSBkYXRhLnNvbWUoKGl0ZW06IGFueSkgPT4gaXRlbS5lbWFpbCk7XG4gICAgfVxuICAgIGlmIChzYW1wbGUucGhvbmUpIHtcbiAgICAgIHJlc3VsdHMuaGFzUGhvbmUgPSBkYXRhLnNvbWUoKGl0ZW06IGFueSkgPT4gaXRlbS5waG9uZSk7XG4gICAgfVxuICAgIGlmIChzYW1wbGUuYW1vdW50IHx8IHNhbXBsZS5wcmljZSkge1xuICAgICAgY29uc3QgYW1vdW50RmllbGQgPSBzYW1wbGUuYW1vdW50ID8gJ2Ftb3VudCcgOiAncHJpY2UnO1xuICAgICAgcmVzdWx0cy50b3RhbEFtb3VudCA9IGRhdGEucmVkdWNlKChzdW06IG51bWJlciwgaXRlbTogYW55KSA9PiBzdW0gKyAoaXRlbVthbW91bnRGaWVsZF0gfHwgMCksIDApO1xuICAgIH1cbiAgICBpZiAoc2FtcGxlLmNhdGVnb3J5KSB7XG4gICAgICByZXN1bHRzLmNhdGVnb3JpZXMgPSBbLi4ubmV3IFNldChkYXRhLm1hcCgoaXRlbTogYW55KSA9PiBpdGVtLmNhdGVnb3J5KS5maWx0ZXIoQm9vbGVhbikpXTtcbiAgICB9XG4gICAgaWYgKHNhbXBsZS5sZXZlbCkge1xuICAgICAgcmVzdWx0cy5lcnJvckNvdW50ID0gZGF0YS5maWx0ZXIoKGl0ZW06IGFueSkgPT4gaXRlbS5sZXZlbCA9PT0gJ2Vycm9yJykubGVuZ3RoO1xuICAgIH1cbiAgfVxuICBcbiAgcmV0dXJuIHJlc3VsdHM7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZVF1YWxpdHlTY29yZShkYXRhOiBhbnkpOiBudW1iZXIge1xuICBsZXQgc2NvcmUgPSAxMDA7XG4gIFxuICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gMCkgc2NvcmUgLT0gMjA7XG4gICAgaWYgKGRhdGEubGVuZ3RoID4gMTAwMCkgc2NvcmUgLT0gMTA7XG4gICAgXG4gICAgLy8gQ2hlY2sgZm9yIG1pc3NpbmcgcmVxdWlyZWQgZmllbGRzXG4gICAgY29uc3Qgc2FtcGxlID0gZGF0YVswXTtcbiAgICBpZiAoc2FtcGxlKSB7XG4gICAgICBzY29yZSAtPSBjYWxjdWxhdGVNaXNzaW5nRmllbGRzUGVuYWx0eShzYW1wbGUpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBzY29yZSAtPSBjYWxjdWxhdGVNaXNzaW5nRmllbGRzUGVuYWx0eShkYXRhKTtcbiAgfVxuICBcbiAgcmV0dXJuIE1hdGgubWF4KDAsIHNjb3JlKTtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlTWlzc2luZ0ZpZWxkc1BlbmFsdHkoaXRlbTogYW55KTogbnVtYmVyIHtcbiAgbGV0IHBlbmFsdHkgPSAwO1xuICBcbiAgLy8gR2VuZXJpYyBwZW5hbHR5IGNhbGN1bGF0aW9uIGZvciBhbnkgZGF0YSB0eXBlXG4gIGlmICghaXRlbS5pZCAmJiAhaXRlbS5uYW1lICYmICFpdGVtLnRpdGxlKSBwZW5hbHR5ICs9IDEwO1xuICBpZiAoT2JqZWN0LmtleXMoaXRlbSkubGVuZ3RoID09PSAwKSBwZW5hbHR5ICs9IDIwO1xuICBcbiAgcmV0dXJuIHBlbmFsdHk7XG59XG4iXX0=