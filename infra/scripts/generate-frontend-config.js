#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

/**
 * Generate frontend configuration from CDK outputs
 * This script reads CDK outputs and generates .env.local for Next.js
 */

function generateFrontendConfig() {
  try {
    console.log('üîß Generating frontend configuration...');

    // Read CDK outputs
    const outputsPath = path.join(__dirname, '../cdk-outputs.json');
    
    if (!fs.existsSync(outputsPath)) {
      console.log('‚ö†Ô∏è  CDK outputs file not found. Run "cdk deploy" first.');
      return;
    }

    const outputs = JSON.parse(fs.readFileSync(outputsPath, 'utf8'));
    
    // Extract values from outputs - get the first (and only) stack
    const stackName = Object.keys(outputs)[0];
    const stackOutputs = outputs[stackName] || {};
    
    // Helper function to find output by pattern
    const findOutputByPattern = (pattern) => {
      const key = Object.keys(stackOutputs).find(k => k.includes(pattern));
      return key ? stackOutputs[key] : undefined;
    };
    
    // Map the actual output keys to our config using pattern matching
    const config = {
      NEXT_PUBLIC_USER_POOL_ID: findOutputByPattern('UserPoolId'),
      NEXT_PUBLIC_IDENTITY_POOL_ID: findOutputByPattern('IdentityPoolId'),
      NEXT_PUBLIC_USER_POOL_CLIENT_ID: findOutputByPattern('UserPoolClientId'),
      NEXT_PUBLIC_API_URL: findOutputByPattern('ApiGatewayUrl'),
      NEXT_PUBLIC_BUCKET: findOutputByPattern('DataBucketName'),
      NEXT_PUBLIC_REGION: process.env.CDK_DEFAULT_REGION || 'us-east-1',
    };

    // Generate .env.local content
    const envContent = Object.entries(config)
      .filter(([_, value]) => value) // Only include non-empty values
      .map(([key, value]) => `${key}=${value}`)
      .join('\n');

    // Write to frontend .env.local
    const envPath = path.join(__dirname, '../../frontend/.env.local');
    fs.writeFileSync(envPath, envContent);

    console.log('‚úÖ Frontend configuration generated successfully!');
    console.log(`üìÅ Configuration written to: ${envPath}`);
    console.log('\nüìã Generated environment variables:');
    Object.entries(config).forEach(([key, value]) => {
      if (value) {
        console.log(`  ${key}=${value}`);
      } else {
        console.log(`  ‚ö†Ô∏è  ${key}=undefined (not found in outputs)`);
      }
    });

    // Also create a config file for reference
    const configPath = path.join(__dirname, '../../frontend/src/config/aws-config.ts');
    const configDir = path.dirname(configPath);
    
    if (!fs.existsSync(configDir)) {
      fs.mkdirSync(configDir, { recursive: true });
    }

    const configContent = `// AWS configuration using environment variables
// These values come from .env.local which is auto-generated by the deployment script

export const awsConfig = {
  Auth: {
    Cognito: {
      region: process.env.NEXT_PUBLIC_REGION || 'us-east-1',
      userPoolId: process.env.NEXT_PUBLIC_USER_POOL_ID || '',
      userPoolClientId: process.env.NEXT_PUBLIC_USER_POOL_CLIENT_ID || '',
      identityPoolId: process.env.NEXT_PUBLIC_IDENTITY_POOL_ID || '',
    },
  },
  API: {
    REST: {
      CortexAI: {
        endpoint: process.env.NEXT_PUBLIC_API_URL || '',
        region: process.env.NEXT_PUBLIC_REGION || 'us-east-1',
      },
    },
  },
  Storage: {
    S3: {
      bucket: process.env.NEXT_PUBLIC_BUCKET || '',
      region: process.env.NEXT_PUBLIC_REGION || 'us-east-1',
    },
  },
};

export default awsConfig;
`;

    fs.writeFileSync(configPath, configContent);
    console.log(`üìÅ AWS config written to: ${configPath}`);

  } catch (error) {
    console.error('‚ùå Error generating frontend configuration:', error);
    process.exit(1);
  }
}

// Run the script
generateFrontendConfig();
